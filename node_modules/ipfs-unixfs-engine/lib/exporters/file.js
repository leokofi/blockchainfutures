'use strict';

var traverse = require('pull-traverse');
var UnixFS = require('ipfs-unixfs');
var pull = require('pull-stream');

// Logic to export a single (possibly chunked) unixfs file.
module.exports = function (node, name, ds) {
  function getData(node) {
    try {
      var _file = UnixFS.unmarshal(node.data);
      return _file.data || new Buffer(0);
    } catch (err) {
      throw new Error('Failed to unmarshal node');
    }
  }

  function visitor(node) {
    return pull(pull.values(node.links), pull.map(function (link) {
      return ds.getStream(link.hash);
    }), pull.flatten());
  }

  var content = pull(traverse.depthFirst(node, visitor), pull.map(getData));

  var file = UnixFS.unmarshal(node.data);
  return pull.values([{
    content: content,
    path: name,
    size: file.fileSize()
  }]);
};