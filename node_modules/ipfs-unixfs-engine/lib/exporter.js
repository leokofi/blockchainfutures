'use strict';

var traverse = require('pull-traverse');
var pull = require('pull-stream');

var util = require('./util');
var switchType = util.switchType;
var cleanMultihash = util.cleanMultihash;

var dirExporter = require('./exporters/dir');
var fileExporter = require('./exporters/file');

module.exports = function (hash, dagService, options) {
  hash = cleanMultihash(hash);
  options = options || {};

  function visitor(item) {
    return pull(dagService.getStream(item.hash), pull.map(function (node) {
      return switchType(node, function () {
        return dirExporter(node, item.path, dagService);
      }, function () {
        return fileExporter(node, item.path, dagService);
      });
    }), pull.flatten());
  }

  // Traverse the DAG
  return pull(dagService.getStream(hash), pull.map(function (node) {
    return switchType(node, function () {
      return traverse.widthFirst({ path: hash, hash: hash }, visitor);
    }, function () {
      return fileExporter(node, hash, dagService);
    });
  }), pull.flatten());
};