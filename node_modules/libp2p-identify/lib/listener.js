'use strict';

var pull = require('pull-stream');
var lp = require('pull-length-prefixed');

var msg = require('./message');

module.exports = function (conn, pInfoSelf) {
  // send what I see from the other + my Info
  conn.getObservedAddrs(function (err, observedAddrs) {
    if (err) {
      return;
    }
    observedAddrs = observedAddrs[0];

    var publicKey = new Buffer(0);
    if (pInfoSelf.id.pubKey) {
      publicKey = pInfoSelf.id.pubKey.bytes;
    }

    var msgSend = msg.encode({
      protocolVersion: 'ipfs/0.1.0',
      agentVersion: 'na',
      publicKey: publicKey,
      listenAddrs: pInfoSelf.multiaddrs.map(function (ma) {
        return ma.buffer;
      }),
      observedAddr: observedAddrs ? observedAddrs.buffer : new Buffer('')
    });

    pull(pull.values([msgSend]), lp.encode(), conn);
  });
};