'use strict';

var series = require('run-series');

var propose = require('./propose');
var exchange = require('./exchange');
var finish = require('./finish');

// Performs initial communication over insecure channel to share
// keys, IDs, and initiate communication, assigning all necessary params.
module.exports = function handshake(state) {
  series([function (cb) {
    return propose(state, cb);
  }, function (cb) {
    return exchange(state, cb);
  }, function (cb) {
    return finish(state, cb);
  }], function (err) {
    state.cleanSecrets();

    if (err) {
      state.shake.abort(err);
    }
  });

  return state.stream;
};