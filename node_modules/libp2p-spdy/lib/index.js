'use strict';

var spdy = require('spdy-transport');
var toStream = require('pull-stream-to-stream');

var Muxer = require('./muxer');
var SPDY_CODEC = require('./spdy-codec');

function create(rawConn, isListener) {
  var conn = toStream(rawConn);
  // Let it flow, let it flooow
  conn.resume();

  conn.on('end', function () {
    // Cleanup and destroy the connection when it ends
    // as the converted stream doesn't emit 'close'
    // but .destroy will trigger a 'close' event.
    conn.destroy();
  });

  var spdyMuxer = spdy.connection.create(conn, {
    protocol: 'spdy',
    isServer: isListener
  });

  return new Muxer(rawConn, spdyMuxer);
}

exports = module.exports = create;
exports.multicodec = SPDY_CODEC;
exports.dialer = function (conn) {
  return create(conn, false);
};
exports.listener = function (conn) {
  return create(conn, true);
};